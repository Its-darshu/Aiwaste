name: Deploy to AWS

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install pytest httpx
        
    - name: Run Tests
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests/

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Check Secrets
      run: |
        if [ -z "${{ secrets.AWS_HOST }}" ]; then echo "::error::AWS_HOST secret is missing!"; exit 1; fi
        if [ -z "${{ secrets.AWS_USERNAME }}" ]; then echo "::error::AWS_USERNAME secret is missing!"; exit 1; fi
        if [ -z "${{ secrets.AWS_SSH_KEY }}" ]; then echo "::error::AWS_SSH_KEY secret is missing!"; exit 1; fi
        echo "All secrets appear to be present."

    - name: Deploy to AWS via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USERNAME }}
        key: ${{ secrets.AWS_SSH_KEY }}
        port: 22
        debug: true
        timeout: 60s
        command_timeout: 30m
        script: |
          set -e
          
          # Configuration
          REPO_URL="https://github.com/${{ github.repository }}.git"
          PROJECT_DIR="$HOME/Aiwaste"
          
          echo "Starting deployment to $PROJECT_DIR..."
          
          # 1. Ensure Project Directory Exists
          if [ -d "$PROJECT_DIR" ]; then
            echo "Directory exists. Updating..."
            cd "$PROJECT_DIR"
            
            # Handle 'dubious ownership' if permissions are mixed
            git config --global --add safe.directory "$PROJECT_DIR" || true
            
            # Reset any local changes
            git fetch origin
            git reset --hard origin/main
          else
            echo "Directory not found. Cloning..."
            # Try cloning. If this is a private repo, this might fail without credentials.
            git clone "$REPO_URL" "$PROJECT_DIR"
            cd "$PROJECT_DIR"
          fi
          
          # 2. Determine Docker Compose Command
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          else
            COMPOSE_CMD="docker compose"
          fi
          
          # 3. Determine Sudo Usage
          # Check if we can run docker without sudo
          if docker info > /dev/null 2>&1; then
            SUDO=""
            echo "Running Docker as current user."
          elif sudo -n docker info > /dev/null 2>&1; then
            SUDO="sudo"
            echo "Running Docker with sudo."
          else
            echo "Error: Cannot run Docker. User is not in 'docker' group and passwordless sudo is unavailable."
            exit 1
          fi
          
          # 4. Deploy
          echo "Rebuilding containers..."
          $SUDO $COMPOSE_CMD -f docker-compose.prod.yml down --remove-orphans
          $SUDO $COMPOSE_CMD -f docker-compose.prod.yml up --build -d
          $SUDO docker image prune -f
          
          echo "Deployment successful!"

name: Deploy to AWS

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install pytest httpx
        
    - name: Run Tests
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests/

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Check Secrets
      run: |
        if [ -z "${{ secrets.AWS_HOST }}" ]; then echo "::error::AWS_HOST secret is missing!"; exit 1; fi
        if [ -z "${{ secrets.AWS_USERNAME }}" ]; then echo "::error::AWS_USERNAME secret is missing!"; exit 1; fi
        if [ -z "${{ secrets.AWS_SSH_KEY }}" ]; then echo "::error::AWS_SSH_KEY secret is missing!"; exit 1; fi
        echo "All secrets appear to be present."

    - name: Deploy to AWS via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USERNAME }}
        key: ${{ secrets.AWS_SSH_KEY }}
        port: 22
        debug: true
        timeout: 60s
        command_timeout: 30m
        script: |
          set -e # Stop script on error
          export TERM=xterm
          
          echo "Starting deployment..."
          
          # 1. Find the project directory
          TARGET_DIR=""
          # Debug: List directories in Home
          ls -d $HOME/*/ || echo "No directories found in $HOME"
          
          for dir in "$HOME/waste" "$HOME/Aiwaste" "/var/www/waste" "/var/www/Aiwaste"; do
            if [ -d "$dir" ]; then
              TARGET_DIR="$dir"
              break
            fi
          done
          
          # Fallback: Try to find directory containing docker-compose.prod.yml
          if [ -z "$TARGET_DIR" ]; then
             echo "Standard paths failed. Searching for docker-compose.prod.yml..."
             FOUND_PATH=$(find $HOME -name "docker-compose.prod.yml" -print -quit)
             if [ -n "$FOUND_PATH" ]; then
               TARGET_DIR=$(dirname "$FOUND_PATH")
             fi
          fi
          
          if [ -z "$TARGET_DIR" ]; then
            echo "Error: Could not find project directory. Please ensure the repo is cloned."
            exit 1
          fi
          
          echo "Found project at: $TARGET_DIR"
          cd "$TARGET_DIR"
          
          # 2. Update Code
          echo "Pulling latest code..."
          # Fix for 'dubious ownership' error if user doesn't own the dir
          git config --global --add safe.directory "$TARGET_DIR" || true
          
          git fetch --all
          git reset --hard origin/main
          
          # 3. Determine Docker Compose Command
          if command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE="docker-compose"
          else
            DOCKER_COMPOSE="docker compose"
          fi
          
          # 4. Check Docker Permissions (Avoid hanging on sudo password)
          if docker info > /dev/null 2>&1; then
            echo "Running docker without sudo..."
            CMD_PREFIX=""
          elif sudo -n docker info > /dev/null 2>&1; then
            echo "Running docker with sudo..."
            CMD_PREFIX="sudo"
          else
            echo "Error: Docker cannot be run. User is not in 'docker' group and passwordless sudo is not available."
            exit 1
          fi
          
          # 5. Rebuild and Restart
          echo "Rebuilding containers..."
          $CMD_PREFIX $DOCKER_COMPOSE -f docker-compose.prod.yml down --remove-orphans
          $CMD_PREFIX $DOCKER_COMPOSE -f docker-compose.prod.yml up --build -d
          $CMD_PREFIX docker image prune -f
          
          echo "Deployment successful!"
